name: macOS Latest iOS 26.2 Development Environment Setup
on:
  workflow_dispatch:
    inputs:
      dummy:
        description: 'Run workflow'
        required: false
        default: ''

jobs:
  macos_ios_setup:
    runs-on: macos-latest
    timeout-minutes: 360 # 6å°æ—¶ï¼Œè¶³å¤Ÿä¸‹è½½å’Œå¤„ç†é•œåƒ
    steps:
      - name: ğŸ“± æ£€æŸ¥iOSå¯ç”¨ç‰ˆæœ¬å’Œé•œåƒ
        run: |
          echo "=== macOS ç³»ç»Ÿç‰ˆæœ¬ ==="
          sw_vers
          
          echo "=== æ£€æŸ¥Xcodeç‰ˆæœ¬ ==="
          xcode-select --version
          xcodebuild -version
          
          echo "=== æ›´æ–°å·¥å…·é“¾åˆ°æœ€æ–° ==="
          sudo xcode-select --reset
          sudo xcode-select --switch /Applications/Xcode.app/Contents/Developer
          
          echo "=== æ£€æŸ¥å¯ç”¨çš„iOSè¿è¡Œæ—¶ ==="
          xcrun simctl runtime list
          
          echo "=== åˆ—å‡ºå·²å®‰è£…çš„iOS SDK ==="
          ls -la /Applications/Xcode.app/Contents/Developer/Platforms/iPhoneOS.platform/Developer/SDKs/ 2>/dev/null || echo "æœªæ‰¾åˆ°SDKç›®å½•"
          
      - name: ğŸ” æœç´¢iOS 26.2å¼€å‘è€…ç£ç›˜é•œåƒ
        run: |
          echo "=== æ£€æŸ¥macOSç³»ç»Ÿç‰ˆæœ¬ ==="
          sw_vers
          
          echo "=== è·å–Xcodeå¯ç”¨çš„SDKç‰ˆæœ¬ ==="
          xcodebuild -showsdks | grep iphoneos
          
          echo "=== æ£€æŸ¥è®¾å¤‡æ”¯æŒç›®å½• ==="
          ls -la ~/Library/Developer/Xcode/iOS\ DeviceSupport/ 2>/dev/null || echo "å°šæ— ä¸‹è½½çš„è®¾å¤‡æ”¯æŒ"
          
      - name: ğŸ“¥ ä¸‹è½½iOS 26.2å¼€å‘å·¥å…·ï¼ˆå¦‚å¯ç”¨ï¼‰
        run: |
          echo "=== å°è¯•æ›´æ–°Xcodeç»„ä»¶ ==="
          sudo xcode-select --switch /Applications/Xcode.app/Contents/Developer
          sudo xcode-select --reset
          
          echo "=== åˆ—å‡ºå¯ä¸‹è½½çš„SDK ==="
          xcodebuild -downloadAllPlatforms || echo "å·²æ˜¯æœ€æ–°ç‰ˆæœ¬æˆ–æ— æ–°ç‰ˆæœ¬å¯ä¸‹è½½"
          
      - name: ğŸ’¾ ç”Ÿæˆé•œåƒä¿¡æ¯æŠ¥å‘Š
        run: |
          {
            echo "# iOS 26.2 å¼€å‘ç¯å¢ƒæ£€æŸ¥æŠ¥å‘Š"
            echo ""
            echo "## ç³»ç»Ÿä¿¡æ¯"
            sw_vers
            echo ""
            echo "## Xcodeä¿¡æ¯"
            xcode-select -p
            xcode-select --version
            echo ""
            echo "## iOS SDKåˆ—è¡¨"
            xcodebuild -showsdks
            echo ""
            echo "## å¯ç”¨è¿è¡Œæ—¶"
            xcrun simctl runtime list
            echo ""
            echo "## Xcodeç»„ä»¶ä½ç½®"
            ls -lh /Applications/Xcode.app/Contents/Developer/Platforms/iPhoneOS.platform/Developer/SDKs/ 2>/dev/null || echo "æœªæ‰¾åˆ°"
          } > ios_setup_report.txt
          
          cat ios_setup_report.txt
          
      - name: ğŸ“¤ ä¸Šä¼ æŠ¥å‘Šä¸ºArtifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ios-setup-report
          path: ios_setup_report.txt
          retention-days: 7
          
      - name: ğŸš€ å¯åŠ¨SSHæœåŠ¡ï¼ˆå¯é€‰è°ƒè¯•ï¼‰
        if: always()
        run: |
          echo "å¦‚éœ€äº¤äº’å¼è°ƒè¯•ï¼Œè¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼š"
          echo "ssh runner@localhost -p 22"
          echo "å¯†ç : runner"
          
          # å¯ç”¨SSH
          sudo systemsetup -setremotelogin on
          sleep 5
          
          # æ˜¾ç¤ºSSHçŠ¶æ€
          sudo systemsetup -getremotelogin
          
      - name: â±ï¸ ä¿æŒä¼šè¯ï¼ˆ2å°æ—¶è°ƒè¯•çª—å£ï¼‰
        run: sleep 7200
