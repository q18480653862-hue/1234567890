name: iOS 26.2 Developer Disk Image Download
on:
  workflow_dispatch:
    inputs:
      ios_version:
        description: 'iOS version (e.g. 26.2)'
        required: true
        default: '26.2'

jobs:
  download_ios_mirror:
    runs-on: macos-latest
    timeout-minutes: 480 # 8å°æ—¶
    steps:
      - name: ğŸ“Š æ˜¾ç¤ºç³»ç»Ÿä¿¡æ¯
        run: |
          echo "=== macOS ç³»ç»Ÿç‰ˆæœ¬ ==="
          sw_vers
          
          echo "=== Xcode ç‰ˆæœ¬ ==="
          xcode-select --version
          xcodebuild -version
          
          echo "=== ç£ç›˜ç©ºé—´ ==="
          df -h
          
      - name: ï¿½ æ›´æ–°å¼€å‘å·¥å…·åˆ°æœ€æ–°ç‰ˆæœ¬
        run: |
          echo "=== æ›´æ–°Xcodeå‘½ä»¤è¡Œå·¥å…· ==="
          sudo xcode-select --reset
          sudo xcode-select --switch /Applications/Xcode.app/Contents/Developer
          
          echo "=== éªŒè¯æ›´æ–°åçš„å·¥å…·ç‰ˆæœ¬ ==="
          xcode-select --version
          xcodebuild -version
          
          echo "=== æ›´æ–°brewåŒ…ç®¡ç†å™¨ ==="
          brew update || true
          
      - name: ï¿½ğŸ” æœç´¢iOS ${{ github.event.inputs.ios_version }} SDK
        run: |
          echo "æ­£åœ¨æœç´¢iOS ${{ github.event.inputs.ios_version }}..."
          
          # åˆ—å‡ºæ‰€æœ‰å¯ç”¨çš„SDK
          echo "=== å¯ç”¨çš„SDKåˆ—è¡¨ ==="
          xcodebuild -showsdks | grep iphoneos
          
          # æ£€æŸ¥æ˜¯å¦å·²å®‰è£…
          echo "=== æ£€æŸ¥iOS ${{ github.event.inputs.ios_version }} æ˜¯å¦å·²å®‰è£… ==="
          if xcrun simctl runtime list | grep -q "${{ github.event.inputs.ios_version }}"; then
            echo "âœ… iOS ${{ github.event.inputs.ios_version }} å·²å®‰è£…"
          else
            echo "âš ï¸  iOS ${{ github.event.inputs.ios_version }} æœªæ‰¾åˆ°"
          fi
          
      - name: ğŸ“¥ å®‰è£…/æ›´æ–°iOS ${{ github.event.inputs.ios_version }} SDK
        run: |
          # å®‰è£…æœ€æ–°çš„å‘½ä»¤è¡Œå·¥å…·
          echo "æ›´æ–°Xcodeå‘½ä»¤è¡Œå·¥å…·..."
          sudo xcode-select --switch /Applications/Xcode.app/Contents/Developer
          sudo xcode-select --reset
          
          # å°è¯•å®‰è£…iOS SDK
          echo "æ£€æŸ¥å¯ä¸‹è½½çš„å¹³å°..."
          xcodebuild -downloadAllPlatforms || true
          
          echo "ç­‰å¾…15ç§’..."
          sleep 15
          
          echo "=== æœ€æ–°çš„å¯ç”¨SDK ==="
          xcodebuild -showsdks | grep iphoneos
          
      - name: ğŸ’¾ è·å–iOS SDKæ–‡ä»¶ä¿¡æ¯
        run: |
          echo "=== iOS SDK ä½ç½® ==="
          SDK_PATH="/Applications/Xcode.app/Contents/Developer/Platforms/iPhoneOS.platform/Developer/SDKs"
          
          if [ -d "$SDK_PATH" ]; then
            echo "æ‰¾åˆ°SDKç›®å½•ï¼š"
            ls -lh "$SDK_PATH"
            
            echo ""
            echo "=== SDKè¯¦ç»†ä¿¡æ¯ ==="
            for sdk in "$SDK_PATH"/*.sdk; do
              if [ -d "$sdk" ]; then
                echo "SDK: $(basename "$sdk")"
                echo "å¤§å°: $(du -sh "$sdk" | cut -f1)"
                echo "è·¯å¾„: $sdk"
                echo ""
              fi
            done
          else
            echo "æœªæ‰¾åˆ°SDKç›®å½•"
          fi
          
      - name: ğŸ“± æ¨¡æ‹Ÿå™¨è¿è¡Œæ—¶æ£€æŸ¥
        run: |
          echo "=== æ‰€æœ‰å¯ç”¨çš„æ¨¡æ‹Ÿå™¨è¿è¡Œæ—¶ ==="
          xcrun simctl runtime list
          
          echo ""
          echo "=== æ¨¡æ‹Ÿå™¨è®¾å¤‡åˆ—è¡¨ ==="
          xcrun simctl list devices
          
      - name: ğŸ”§ åˆ›å»ºæµ‹è¯•iPhoneæ¨¡æ‹Ÿå™¨
        run: |
          echo "åˆ›å»ºiOS ${{ github.event.inputs.ios_version }} æµ‹è¯•è®¾å¤‡..."
          
          # æŸ¥æ‰¾iOS 26.2è¿è¡Œæ—¶
          IOS_RUNTIME=$(xcrun simctl runtime list | grep "iOS ${{ github.event.inputs.ios_version }}" | tail -1 | awk '{print $NF}')
          
          if [ -n "$IOS_RUNTIME" ]; then
            echo "æ‰¾åˆ°è¿è¡Œæ—¶: $IOS_RUNTIME"
            
            # åˆ›å»ºæ¨¡æ‹Ÿå™¨
            xcrun simctl create "iOS${{ github.event.inputs.ios_version }}-test" \
              com.apple.CoreSimulator.SimDeviceType.iPhone-15 \
              "$IOS_RUNTIME" || echo "æ¨¡æ‹Ÿå™¨åˆ›å»ºå¤±è´¥æˆ–å·²å­˜åœ¨"
            
            echo "=== åˆ›å»ºåçš„è®¾å¤‡åˆ—è¡¨ ==="
            xcrun simctl list devices
          else
            echo "âš ï¸  æœªæ‰¾åˆ°iOS ${{ github.event.inputs.ios_version }} è¿è¡Œæ—¶"
          fi
          
      - name: ğŸ“‹ ç”Ÿæˆå®Œæ•´æŠ¥å‘Š
        run: |
          {
            echo "# iOS ${{ github.event.inputs.ios_version }} é•œåƒé…ç½®æŠ¥å‘Š"
            echo "ç”Ÿæˆæ—¶é—´: $(date)"
            echo ""
            echo "## ç³»ç»Ÿç¯å¢ƒ"
            echo "\`\`\`"
            sw_vers
            echo "\`\`\`"
            echo ""
            echo "## Xcodeé…ç½®"
            echo "\`\`\`"
            xcode-select -p
            xcodebuild -version
            echo "\`\`\`"
            echo ""
            echo "## å¯ç”¨SDKåˆ—è¡¨"
            echo "\`\`\`"
            xcodebuild -showsdks | grep iphoneos
            echo "\`\`\`"
            echo ""
            echo "## è¿è¡Œæ—¶"
            echo "\`\`\`"
            xcrun simctl runtime list | grep iOS
            echo "\`\`\`"
            echo ""
            echo "## ç£ç›˜ä½¿ç”¨æƒ…å†µ"
            echo "\`\`\`"
            df -h | grep -E "Filesystem|/Volumes"
            echo "\`\`\`"
          } > ios_mirror_report.md
          
          cat ios_mirror_report.md
          
      - name: ğŸ“¤ ä¸Šä¼ æŠ¥å‘Š
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ios-mirror-report-${{ github.event.inputs.ios_version }}
          path: ios_mirror_report.md
          retention-days: 30
          
      - name: ğŸ’¡ æä¾›ä¸‹ä¸€æ­¥è¯´æ˜
        run: |
          echo "âœ… iOS ${{ github.event.inputs.ios_version }} é•œåƒæ£€æŸ¥å®Œæˆï¼"
          echo ""
          echo "ğŸ“Œ ä¸‹ä¸€æ­¥æ“ä½œï¼š"
          echo "1. æ£€æŸ¥ä¸Šé¢ç”Ÿæˆçš„æŠ¥å‘Šä¸­çš„SDKå’Œè¿è¡Œæ—¶ä¿¡æ¯"
          echo "2. å¦‚éœ€å¼€å‘ï¼Œå¯åœ¨è¿™ä¸ªmacOSç¯å¢ƒä¸­è¿›è¡Œï¼š"
          echo "   - Xcodeå¼€å‘"
          echo "   - æ¨¡æ‹Ÿå™¨è°ƒè¯•"
          echo "   - ç¼–è¯‘å’Œæ‰“åŒ…åº”ç”¨"
          echo ""
          echo "ğŸ’¾ æœ¬æ¬¡è¿è¡Œçš„å®Œæ•´æŠ¥å‘Šå·²ä¿å­˜ä¸ºArtifactï¼Œå¯ä»Actionsé¡µé¢ä¸‹è½½"
